---
title: "P8105 Midterm Project — EOP, FHP, Age, and Sex"
author: "Yongyan Liu (yl6107)"
output:
  github_document:
    toc: true
    toc_depth: 2
    df_print: default
editor_options:
  chunk_output_type: inline
---

```{r libs, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(broom)
library(scales)
```

## Intro

This project is about posture and a head bump called the **external occipital protuberance (EOP)**. We use a dataset that came with the authors’ correction. We will clean the data, make better plots and check the claims.

## Problem 1 — Data (import, clean, describe)

Read the Excel file from `data/`. The real data start on line 9 of sheet **“this one”**. Clean names. Make clear labels for **sex**, **age group**. 

We didn't fill the missing data in **eop_mm** and **fhp_mm** column even if we can *guess* a value from the corresponding category. If we do so, a lot of statistics, like the mean size, will be polluted.

```{r load-clean}
path_xlsx <- "data/p8105_mtp_data.xlsx"
stopifnot(file.exists(path_xlsx))

raw <- read_excel(path_xlsx, sheet = "this one", skip = 8) |>
  clean_names()

# Standardize core columns
dat <- raw |>
  rename(
    sex_num      = sex,
    age_years    = age,
    age_group_id = age_group,
    eop_mm       = eop_size_mm,
    eop_cat_raw  = eop_size,
    eop_vis      = eop_visibility_classification,
    eop_shape    = eop_shape,
    fhp_mm       = fhp_size_mm,
    fhp_cat      = fhp_category
  ) |>
  mutate(
    sex = case_when(sex_num == 1 ~ "Male",
                    sex_num == 0 ~ "Female",
                    TRUE ~ as.character(sex_num)),
    sex = factor(sex, levels = c("Male","Female")),
    age_group = case_when(
      age_group_id == 2 ~ "18–30",
      age_group_id == 3 ~ "31–40",
      age_group_id == 4 ~ "41–50",
      age_group_id == 5 ~ "51–60",
      age_group_id %in% c(6,7,8) ~ "60+",
      TRUE ~ NA_character_
    ) |> factor(levels = c("18–30","31–40","41–50","51–60","60+"), ordered = TRUE),
    eop_cat = as.integer(eop_cat_raw),
    fhp_cat = as.integer(fhp_cat),
    # Enlarged EOP per assignment: categories 2–5 are "enlarged"
    eeop = (eop_cat >= 2)
  ) |>
  mutate(
    # EOP: compare mm to categorical (only when BOTH present)
    eop_mismatch = !is.na(eop_mm) & !is.na(eop_cat) &
      (eop_mm < eop_cat * 5 | eop_mm > (eop_cat + 1) * 5),
    
    # FHP: compare mm to categorical (only when BOTH present)
    fhp_mismatch = !is.na(fhp_mm) & !is.na(fhp_cat) &
      (fhp_mm < fhp_cat * 10 | fhp_mm > (fhp_cat + 1) * 10),

    # Mark invalid rows
    invalid = eop_mismatch | fhp_mismatch
  ) |>
  select(sex, age_years, age_group, eop_mm, eop_cat, eeop, eop_vis, eop_shape, fhp_mm, fhp_cat, eop_mismatch, fhp_mismatch, invalid)

```

Total number of participants and the sex distribution are shown as below, as well as a summary of EOP and FHP size.

```{r}
# Quick sanity checks
n_total <- nrow(dat)
n_by_sex <- dat |>
  count(sex, name = "n") |>
  mutate(p = n / sum(n))

n_total
n_by_sex
summary(dat[,c("age_years","fhp_mm","eop_mm")])
```

**Notes.**

- Age groups are ordered from **18–30** up to **60+**.
- We use **EEOP = TRUE** if **EOP category ≥ 2** from the definition in the article.
- Since a lot of rows have **eop_mm** missing, we tolerate the missing rows. But, if the value of **eop_mm** and **eop_cat** are contradictory to each other, we mark the row as **invalid**. We also treat FHP in the same way.

Here is a summary about the missing rows.

```{r mismatch}
# Summaries required in step 2
mismatch_summary <- dat %>%
  summarise(
    eop_mm_vs_cat_mismatch   = sum(eop_mismatch, na.rm = TRUE),
    fhp_mm_vs_cat_mismatch   = sum(fhp_mismatch, na.rm = TRUE),
    all_matched_ok_rows      = sum(!invalid, na.rm = TRUE),
    total_rows               = n()
  )

print(mismatch_summary)

# remove the 2 mismatch flags and only keep the 'invalid' flag
dat <- dat |> select(-eop_mismatch, -fhp_mismatch)

```
