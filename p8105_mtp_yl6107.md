P8105 Midterm Project — EOP, FHP, Age, and Sex
================
Yongyan Liu (yl6107)

- [Intro](#intro)
- [Problem 1 — Data (import, clean,
  describe)](#problem-1--data-import-clean-describe)
- [Problem 2 — Plots (better than the
  originals)](#problem-2--plots-better-than-the-originals)

``` r
library(tidyverse)
library(readxl)
library(janitor)
library(broom)
library(scales)
library(patchwork)
```

## Intro

This project is about posture and a head bump called the **external
occipital protuberance (EOP)**. We use a dataset that came with the
authors’ correction. We will clean the data, make better plots and check
the claims.

## Problem 1 — Data (import, clean, describe)

Read the Excel file from `data/`. The real data start on line 9 of sheet
**“this one”**. Clean names. Make clear labels for **sex**, **age
group**.

Missing **age_group** are filled, but we didn’t fill the missing data in
**eop_mm** and **fhp_mm** column even if we can *guess* a value from the
corresponding category. If we do so, a lot of statistics, like the mean
size, will be polluted.

``` r
path_xlsx <- "data/p8105_mtp_data.xlsx"
stopifnot(file.exists(path_xlsx))

raw <- read_excel(path_xlsx, sheet = "this one", skip = 8) |>
  clean_names()

# Standardize core columns
dat <- raw |>
  rename(
    sex_num      = sex,
    age_years    = age,
    eop_mm       = eop_size_mm,
    eop_cat_raw  = eop_size,
    eop_vis      = eop_visibility_classification,
    eop_shape    = eop_shape,
    fhp_mm       = fhp_size_mm,
    fhp_cat      = fhp_category
  ) |>
  mutate(
    sex = case_when(sex_num == 1 ~ "Male",
                    sex_num == 0 ~ "Female",
                    TRUE ~ as.character(sex_num)),
    sex = factor(sex, levels = c("Male","Female")),
    age_group = case_when(
      age_group == 2 ~ "18–30",
      age_group == 3 ~ "31–40",
      age_group == 4 ~ "41–50",
      age_group == 5 ~ "51–60",
      age_group %in% c(6, 7, 8) ~ "60+",
      # if missing, compute from age_years
      TRUE ~ case_when(
        age_years <= 30 ~ "18–30",
        age_years <= 40 ~ "31–40",
        age_years <= 50 ~ "41–50",
        age_years <= 60 ~ "51–60",
        age_years > 60  ~ "60+",
        TRUE ~ NA_character_
      )
    ) |> factor(levels = c("18–30","31–40","41–50","51–60","60+"), ordered = TRUE),
    eop_cat = as.integer(eop_cat_raw),
    fhp_cat = as.integer(fhp_cat),
    # Enlarged EOP per assignment: categories 2–5 are "enlarged"
    eeop = (eop_cat >= 2)
  ) |>
  mutate(
    # EOP: compare mm to categorical (only when BOTH present)
    eop_mismatch = !is.na(eop_mm) & !is.na(eop_cat) &
      (eop_mm < eop_cat * 5 | eop_mm > (eop_cat + 1) * 5),
    
    # FHP: compare mm to categorical (only when BOTH present)
    fhp_mismatch = !is.na(fhp_mm) & !is.na(fhp_cat) &
      (fhp_mm < fhp_cat * 10 | fhp_mm > (fhp_cat + 1) * 10),

    # Mark invalid rows
    invalid = eop_mismatch | fhp_mismatch
  ) |>
  select(sex, age_years, age_group, eop_mm, eop_cat, eeop, eop_vis, eop_shape, fhp_mm, fhp_cat, eop_mismatch, fhp_mismatch, invalid)
```

Total number of participants and the sex distribution are shown as
below, as well as a summary of EOP and FHP size.

``` r
# Quick sanity checks
n_total <- nrow(dat)
n_by_sex <- dat |>
  count(sex, name = "n") |>
  mutate(p = n / sum(n))

n_total
```

    ## [1] 1221

``` r
n_by_sex
```

    ## # A tibble: 2 × 3
    ##   sex        n     p
    ##   <fct>  <int> <dbl>
    ## 1 Male     607 0.497
    ## 2 Female   614 0.503

``` r
summary(dat[,c("age_years","fhp_mm","eop_mm")])
```

    ##    age_years         fhp_mm          eop_mm     
    ##  Min.   :17.00   Min.   : 0.00   Min.   : 0.00  
    ##  1st Qu.:31.00   1st Qu.:17.20   1st Qu.: 8.20  
    ##  Median :45.00   Median :24.60   Median :10.80  
    ##  Mean   :45.51   Mean   :26.10   Mean   :11.87  
    ##  3rd Qu.:60.00   3rd Qu.:32.75   3rd Qu.:14.50  
    ##  Max.   :88.00   Max.   :89.30   Max.   :35.70  
    ##                  NA's   :6       NA's   :518

**Notes.**

- Age groups are ordered from **18–30** up to **60+**.
- We use **EEOP = TRUE** if **EOP category ≥ 2** from the definition in
  the article.
- Since a lot of rows have **eop_mm** missing, we tolerate the missing
  rows. But, if the value of **eop_mm** and **eop_cat** are
  contradictory to each other, we mark the row as **invalid**. We also
  treat FHP in the same way.

Here is a summary about the missing rows.

``` r
# Summaries required in step 2
mismatch_summary <- dat %>%
  summarise(
    eop_mm_vs_cat_mismatch   = sum(eop_mismatch, na.rm = TRUE),
    fhp_mm_vs_cat_mismatch   = sum(fhp_mismatch, na.rm = TRUE),
    all_matched_ok_rows      = sum(!invalid, na.rm = TRUE),
    total_rows               = n()
  )

print(mismatch_summary)
```

    ## # A tibble: 1 × 4
    ##   eop_mm_vs_cat_mismatch fhp_mm_vs_cat_mismatch all_matched_ok_rows total_rows
    ##                    <int>                  <int>               <int>      <int>
    ## 1                     14                     27                1180       1221

Inconsistent data are excluded from the data set.

``` r
# remove the invlid rows
dat <- dat |> 
  filter(!invalid) |>
  filter(!is.na(age_years)) |>
  select(-eop_mismatch, -fhp_mismatch, -invalid)
```

## Problem 2 — Plots (better than the originals)

The violin diagram below shows the distribution of FHP size in each
age/sex group. And, the bar chart shows the EEOP rate in each age/sex
group.

``` r
# FHP distribution (violin + box), by age and sex
p_fhp <- dat |>
  filter(!is.na(fhp_mm)) |>
  ggplot(aes(x = age_group, y = fhp_mm, fill = sex)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width = 0.18, outlier.alpha = 0.4,
               position = position_dodge2(width = 0.9)) +
  labs(x = "Age group", y = "FHP (mm)",
       title = "FHP distribution by age group and sex") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")

# Calculate EEOP rate by eage and sex
eeop_by <- dat |>
  group_by(sex, age_group) |>
  summarise(n = dplyr::n(),
            rate_eeop = mean(eeop, na.rm = TRUE), .groups = "drop")

p_rate <- eeop_by |>
  ggplot(aes(x = age_group, y = rate_eeop, fill = sex)) +
  geom_col(position = position_dodge(width = 0.9)) +
  geom_text(aes(label = percent(rate_eeop, accuracy = 0.1)),
            position = position_dodge(width = 0.9),
            vjust = -0.25, size = 3) +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
  labs(x = "Age group", y = "EEOP rate",
       title = "Enlarged EOP (EEOP) rate by age group and sex") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")

p_fhp / p_rate + plot_annotation(title = "Two-panel figure: FHP distribution and EEOP rate")
```

![](p8105_mtp_yl6107_files/figure-gfm/fig-fhp-1.png)<!-- -->

The plot below shows the correlation between EOP size and FHP by age and
sex.

``` r
# 2 × 5 grid: FHP vs EOP size (category), split by age × sex
eop_mid_map <- c("0" = 2.5, "1" = 7.5, "2" = 12.5, "3" = 17.5, "4" = 22.5, "5" = 27.5)

# filter out rows without eop_mm and fhp_mm data
dat_scatter <- dat |> filter(!is.na(eop_mm) & !is.na(fhp_mm))

# dot plot (scatter), optional faint linear trend to show association
p_scatter <- ggplot(
  dat_scatter,
  aes(x = fhp_mm, y = eop_mm)
) +
  geom_point(alpha = 0.45, size = 1.6) +
  # comment next line if you want strictly "dots only"
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.6, linetype = "22", color = "grey40") +
  facet_grid(rows = vars(sex), cols = vars(age_group)) +
  labs(
    x = "FHP size (mm)",
    y = "EOP size (mm)",
    title = "Association between FHP size and EOP size across age × sex (2 × 5 panels)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )

p_scatter
```

![](p8105_mtp_yl6107_files/figure-gfm/fig-grid-1.png)<!-- -->

Overall, males show a clearly higher rate of enlarged external occipital
protuberance (EEOP) than females across all age groups.

The range and distribution of forward head posture (FHP) values are
generally similar between men and women, although males tend to have
slightly wider variability.

Across all panels, there is no obvious visual association between FHP
size and EOP size — dots are scattered rather randomly, and no
consistent trend appears.

There is also some indication that EOP size variation may plateau in
older age groups, but without a strong pattern linking posture to bony
growth.
